<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, interactive-widget=resizes-content">
    <title>Wayne Core Omni-God V10</title>
    
    <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
    <script>
      window.OneSignalDeferred = window.OneSignalDeferred || [];
      OneSignalDeferred.push(async (OS) => { await OS.init({ appId: "3504bc48-2267-4c0b-817d-faf41d5057c2" }); });
    </script>

    <style>
        :root {
            --bg: #0b0e14; --card: #1c2128; --text: #adbac7;
            --primary: #a855f7; --my-msg: #3e334a; --other-msg: #22272e;
            --whisper: #eab308; --danger: #f85149; --read: #3fb950;
        }
        [data-theme="light"] {
            --bg: #f4f4f5; --card: #ffffff; --text: #09090b;
            --primary: #7c3aed; --my-msg: #7c3aed; --other-msg: #e4e4e7;
            --my-text: white;
        }
        * { box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; background: var(--bg); color: var(--text); height: 100dvh; display: flex; flex-direction: column; overflow: hidden; }

        /* --- UI COMPONENTS --- */
        header { 
            padding: 12px 16px; background: var(--card); border-bottom: 1px solid #444c56;
            display: flex; justify-content: space-between; align-items: center; z-index: 100;
        }
        
        #sidebar { 
            width: 260px; background: var(--card); border-right: 1px solid #444c56;
            position: absolute; left: -260px; height: 100%; transition: 0.3s; z-index: 50; display: flex; flex-direction: column;
        }
        #sidebar.open { left: 0; box-shadow: 10px 0 30px rgba(0,0,0,0.5); }

        #msg-container { flex: 1; display: flex; flex-direction: column; min-width: 0; position: relative; }
        #messages { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 12px; }

        /* --- BUBBLES & CONTENT --- */
        .msg-row { display: flex; gap: 8px; max-width: 85%; align-self: flex-start; animation: fadeIn 0.2s; }
        .mine { align-self: flex-end; flex-direction: row-reverse; }
        
        .bubble { 
            padding: 10px 14px; border-radius: 18px; font-size: 15px; line-height: 1.4;
            position: relative; word-wrap: break-word; cursor: pointer; min-width: 60px;
        }
        .mine .bubble { background: var(--my-msg); color: var(--my-text, #fff); border-bottom-right-radius: 4px; }
        .theirs .bubble { background: var(--other-msg); border-bottom-left-radius: 4px; border: 1px solid #444c56; }
        
        .reply-box { 
            background: rgba(0,0,0,0.2); border-left: 3px solid var(--primary); 
            padding: 4px 8px; margin-bottom: 6px; font-size: 11px; border-radius: 4px; opacity: 0.8;
        }
        
        .bubble img { max-width: 100%; border-radius: 10px; margin-top: 5px; display: block; }
        audio { height: 32px; max-width: 200px; margin-top: 5px; }

        /* --- METADATA (Time + Read Receipts) --- */
        .meta { 
            display: flex; justify-content: flex-end; align-items: center; gap: 4px; 
            font-size: 9px; opacity: 0.6; margin-top: 4px; 
        }
        .read-icon { font-size: 11px; font-weight: bold; }
        .read-icon.seen { color: var(--read); }

        /* --- REACTIONS --- */
        .reactions { 
            position: absolute; bottom: -12px; right: 0; 
            background: var(--card); border: 1px solid #444c56; 
            border-radius: 10px; padding: 2px 6px; font-size: 10px; display: flex; gap: 2px;
        }

        /* --- POLLS --- */
        .poll-card { background: rgba(168, 85, 247, 0.1); border: 1px solid var(--primary); padding: 12px; border-radius: 12px; width: 100%; margin-bottom: 10px; }
        .poll-opt { background: rgba(255,255,255,0.05); padding: 8px; margin: 5px 0; border-radius: 6px; cursor: pointer; position: relative; overflow: hidden; }
        .poll-bar { position: absolute; left: 0; top: 0; height: 100%; background: var(--primary); opacity: 0.3; transition: 0.5s; }

        /* --- INPUT AREA --- */
        #input-panel { padding: 10px; background: var(--card); border-top: 1px solid #444c56; }
        .input-wrapper { background: var(--bg); border-radius: 24px; padding: 4px 8px; display: flex; align-items: center; border: 1px solid #444c56; }
        #text-input { flex: 1; background: transparent; border: none; color: var(--text); padding: 10px; outline: none; font-size: 16px; }
        .action-bar { display: none; background: #2d333b; padding: 8px 15px; border-top: 1px solid var(--primary); justify-content: space-between; font-size: 12px; }
        
        /* --- LOGIN & UTILS --- */
        #login-overlay { position: fixed; inset: 0; background: #000; z-index: 5000; display: flex; align-items: center; justify-content: center; }
        .login-box { background: var(--card); padding: 30px; border-radius: 20px; text-align: center; border: 1px solid var(--primary); width: 85%; max-width: 320px; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body data-theme="dark">

<div id="login-overlay">
    <div class="login-box">
        <h2 style="color:var(--primary); margin:0 0 5px 0;">WAYNE CORE</h2>
        <small style="opacity:0.5; display:block; margin-bottom:20px;">OMNI-GOD V10</small>
        <input type="password" id="secret-code" placeholder="Secret Code" style="width:100%; padding:12px; margin-bottom:10px; border-radius:8px; border:none; background:#0b0e14; color:white; text-align:center;">
        <input type="text" id="username" placeholder="Codename" maxlength="12" style="width:100%; padding:12px; margin-bottom:20px; border-radius:8px; border:none; background:#0b0e14; color:white; text-align:center;">
        <button onclick="login()" style="width:100%; padding:12px; background:var(--primary); color:white; border:none; border-radius:8px; font-weight:bold;">INITIALIZE</button>
    </div>
</div>

<header>
    <div style="display:flex; align-items:center; gap:12px;">
        <button onclick="document.getElementById('sidebar').classList.toggle('open')" style="background:none; border:none; color:var(--text); font-size:22px;">‚ò∞</button>
        <b style="letter-spacing:1px;">WAYNE CORE</b>
        <div id="status-dot" style="width:8px; height:8px; background:#3fb950; border-radius:50%; box-shadow: 0 0 8px #3fb950;"></div>
    </div>
    <div style="display:flex; gap:10px;">
        <button onclick="toggleTheme()" style="background:none; border:1px solid #444c56; color:var(--text); padding:4px 8px; border-radius:6px; font-size:10px;">üåì</button>
        <button onclick="purgeChat()" style="background:var(--danger); border:none; color:white; padding:4px 8px; border-radius:6px; font-size:10px; font-weight:bold;">PURGE</button>
    </div>
</header>

<div id="main-layout">
    <div id="sidebar">
        <div style="padding:15px; font-weight:bold; color:var(--primary); border-bottom:1px solid #444c56;">ACTIVE NODES</div>
        <div id="user-list" style="flex:1; overflow-y:auto;"></div>
        <button onclick="createPoll()" style="margin:10px; padding:10px; background:rgba(168,85,247,0.2); border:1px solid var(--primary); color:var(--primary); border-radius:8px;">+ CREATE POLL</button>
    </div>
    
    <div id="msg-container">
        <div id="messages"></div>
        <div id="typing-indicator" style="padding:0 20px; font-size:10px; height:15px; color:var(--primary); font-style:italic;"></div>
        
        <div id="reply-preview" class="action-bar">
            <span>Replying to <b id="reply-user"></b></span>
            <button onclick="cancelReply()" style="background:none; border:none; color:var(--danger);">‚úï</button>
        </div>
        <div id="whisper-preview" class="action-bar" style="background:var(--whisper); color:black;">
            <span id="whisper-info"></span>
            <button onclick="cancelWhisper()" style="background:none; border:none; color:black;">‚úï</button>
        </div>

        <div id="input-panel">
            <div class="input-wrapper">
                <input type="file" id="file-in" style="display:none" accept="image/*">
                <button onclick="document.getElementById('file-in').click()" style="background:none; border:none; font-size:18px; cursor:pointer;">üñºÔ∏è</button>
                <button id="rec-btn" style="background:none; border:none; font-size:18px; cursor:pointer;">üéôÔ∏è</button>
                
                <input id="text-input" placeholder="Secure Message..." autocomplete="off" maxlength="500">
                <span id="char-counter" style="font-size:10px; color:#666; padding-right:5px;">0/500</span>
                
                <button onclick="sendMessage()" style="background:none; border:none; font-size:18px; cursor:pointer;">üöÄ</button>
            </div>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, push, onValue, set, remove, onDisconnect, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const config = {
      apiKey: "AIzaSyBm_1W_5MRFJEOJZ4-6itgacgSon3DG-H0",
      authDomain: "supreme-chat-22cf4.firebaseapp.com",
      databaseURL: "https://supreme-chat-22cf4-default-rtdb.firebaseio.com",
      projectId: "supreme-chat-22cf4",
      storageBucket: "supreme-chat-22cf4.firebasestorage.app",
      messagingSenderId: "475930341104",
      appId: "1:475930341104:web:f3ee96117523bb914c5c35"
    };

    const app = initializeApp(config);
    const db = getDatabase(app);

    // --- STATE ---
    const SECRET = "WAYNE";
    const myId = "node_" + Math.random().toString(36).substr(2, 6);
    let myUser = localStorage.getItem('wc_omni_user');
    let activeReply = null, whisperTarget = null;
    let mediaRec, audioChunks = [];

    if(myUser) {
        document.getElementById('login-overlay').style.display='none';
        initApp();
    }

    window.login = () => {
        const code = document.getElementById('secret-code').value;
        const user = document.getElementById('username').value.trim();
        if(code === SECRET && user) {
            localStorage.setItem('wc_omni_user', user);
            location.reload();
        } else { alert("ACCESS DENIED"); }
    };

    function initApp() {
        // 1. Presence
        const pRef = ref(db, 'online/' + myId);
        set(pRef, { name: myUser });
        onDisconnect(pRef).remove();
        onValue(ref(db, 'online'), snap => {
            document.getElementById('user-list').innerHTML = Object.entries(snap.val()||{}).map(([k,v]) => `
                <div onclick="setWhisper('${k}','${v.name}')" style="padding:10px; cursor:pointer; border-bottom:1px solid #333;">üü¢ ${v.name}</div>
            `).join('');
        });

        // 2. Messages & Read Receipts
        onValue(ref(db, 'messages'), snap => {
            const list = document.getElementById('messages');
            list.innerHTML = '';
            snap.forEach(child => {
                const m = child.val();
                if(!m.toId || m.toId === myId || m.uid === myId) {
                    renderMsg(child.key, m);
                    // Mark as Read if not mine
                    if(m.uid !== myId && (!m.readBy || !m.readBy[myId])) {
                        update(ref(db, `messages/${child.key}/readBy`), { [myId]: true });
                    }
                }
            });
            // 3. Polls
            onValue(ref(db, 'polls'), pSnap => {
                pSnap.forEach(pChild => renderPoll(pChild.key, pChild.val()));
            });
            list.scrollTop = list.scrollHeight;
        });

        // 4. Typing
        const tRef = ref(db, 'typing/' + myId);
        document.getElementById('text-input').oninput = (e) => {
            const len = e.target.value.length;
            document.getElementById('char-counter').innerText = len + "/500";
            set(tRef, { name: myUser, active: len > 0 });
            clearTimeout(window.tTime);
            window.tTime = setTimeout(() => set(tRef, { active: false }), 2000);
        };
        onValue(ref(db, 'typing'), snap => {
            const t = Object.values(snap.val()||{}).find(x => x.active && x.name !== myUser);
            document.getElementById('typing-indicator').innerText = t ? `${t.name} is typing...` : "";
        });
    }

    // --- RENDERING ---
    function renderMsg(key, m) {
        const isMine = m.uid === myId;
        const seenCount = m.readBy ? Object.keys(m.readBy).length : 0;
        const ticks = seenCount > 0 ? '‚úì‚úì' : '‚úì';
        const tickClass = seenCount > 0 ? 'read-icon seen' : 'read-icon';
        
        const div = document.createElement('div');
        div.className = `msg-row ${isMine ? 'mine' : ''}`;
        
        let content = m.text || '';
        if(m.img) content += `<img src="${m.img}">`;
        if(m.audio) content += `<audio controls src="${m.audio}"></audio>`;

        div.innerHTML = `
            <div class="bubble" onclick="msgClick('${key}', '${m.uid}', '${m.user}', '${m.text||'media'}')">
                <small style="opacity:0.5; font-size:10px; display:block;">${m.toId ? 'üîí Whisper' : m.user}</small>
                ${m.reply ? `<div class="reply-box"><b>@${m.reply.user}:</b> ${m.reply.text}</div>` : ''}
                <div>${content}</div>
                
                <div class="meta">
                    <span>${new Date(m.time).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</span>
                    ${isMine ? `<span class="${tickClass}">${ticks}</span>` : ''}
                </div>
                
                ${m.reactions ? `<div class="reactions">${Object.keys(m.reactions).join('')}</div>` : ''}
            </div>
        `;
        document.getElementById('messages').appendChild(div);
    }

    function renderPoll(key, p) {
        const total = p.votes ? Object.keys(p.votes).length : 0;
        const div = document.createElement('div');
        div.className = 'poll-card';
        div.innerHTML = `<b style="color:var(--primary)">üìä ${p.q}</b>` + p.opts.map((o, i) => {
            const count = p.votes ? Object.values(p.votes).filter(v => v === i).length : 0;
            const pct = total ? Math.round((count/total)*100) : 0;
            return `<div class="poll-opt" onclick="vote('${key}', ${i})">
                <div class="poll-bar" style="width:${pct}%"></div>
                <div style="position:relative; z-index:2; display:flex; justify-content:space-between;">
                    <span>${o}</span><span>${count} (${pct}%)</span>
                </div>
            </div>`;
        }).join('');
        document.getElementById('messages').appendChild(div);
    }

    // --- ACTIONS ---
    window.sendMessage = () => {
        const inp = document.getElementById('text-input');
        if(inp.value.trim()) {
            push(ref(db, 'messages'), {
                text: inp.value, user: myUser, uid: myId,
                toId: whisperTarget, reply: activeReply, time: Date.now()
            });
            sendPush(inp.value);
            inp.value = ''; cancelReply(); cancelWhisper();
        }
    };

    window.msgClick = (key, uid, user, text) => {
        if(uid === myId) {
            if(confirm("Delete message?")) remove(ref(db, `messages/${key}`));
        } else {
            if(confirm("Reply or React?\nOK = Reply\nCancel = React")) {
                activeReply = { user, text: text.substring(0,30)+'...' };
                document.getElementById('reply-preview').style.display = 'flex';
                document.getElementById('reply-user').innerText = user;
            } else {
                const emo = prompt("Emoji:");
                if(emo) update(ref(db, `messages/${key}/reactions`), { [emo]: true });
            }
        }
    };

    // --- MEDIA ---
    document.getElementById('file-in').onchange = e => {
        const r = new FileReader();
        r.onload = () => push(ref(db, 'messages'), { img: r.result, user: myUser, uid: myId, time: Date.now() });
        r.readAsDataURL(e.target.files[0]);
    };
    
    document.getElementById('rec-btn').onclick = async () => {
        if(!mediaRec || mediaRec.state === 'inactive') {
            const s = await navigator.mediaDevices.getUserMedia({audio:true});
            mediaRec = new MediaRecorder(s);
            mediaRec.ondataavailable = e => audioChunks.push(e.data);
            mediaRec.onstop = () => {
                const b = new Blob(audioChunks);
                const r = new FileReader();
                r.onload = () => push(ref(db, 'messages'), { audio: r.result, user: myUser, uid: myId, time: Date.now() });
                r.readAsDataURL(b); audioChunks=[];
            };
            mediaRec.start();
            document.getElementById('rec-btn').innerText = 'üü•';
        } else {
            mediaRec.stop();
            document.getElementById('rec-btn').innerText = 'üéôÔ∏è';
        }
    };

    // --- UTILS ---
    window.createPoll = () => {
        const q = prompt("Poll Question:");
        const o = prompt("Options (comma separated):");
        if(q && o) push(ref(db, 'polls'), { q, opts: o.split(','), votes: {} });
    };
    window.vote = (k, i) => update(ref(db, `polls/${k}/votes`), { [myId]: i });
    
    window.setWhisper = (id, name) => {
        whisperTarget = id;
        document.getElementById('whisper-preview').style.display='flex';
        document.getElementById('whisper-info').innerText = "üîí Whispering to " + name;
    };
    
    async function sendPush(msg) {
        if(whisperTarget) return;
        try { await fetch("https://onesignal.com/api/v1/notifications", {
            method: "POST",
            headers: {"Content-Type": "application/json", "Authorization": "Basic os_v2_app_guclysbcm5gaxal57l2b2ucxyipnvwbknj4uqcfjtiq7ngm3a5kpfzmqxvl5arjwul577o4s4eaxsppypzlmjo45totbvf6ewfnv24a"},
            body: JSON.stringify({ app_id: "3504bc48-2267-4c0b-817d-faf41d5057c2", included_segments: ["Total Subscriptions"], contents: {"en": `${myUser}: ${msg}`} })
        }); } catch(e){}
    }

    window.cancelReply = () => { activeReply=null; document.getElementById('reply-preview').style.display='none'; };
    window.cancelWhisper = () => { whisperTarget=null; document.getElementById('whisper-preview').style.display='none'; };
    window.toggleTheme = () => document.body.setAttribute('data-theme', document.body.getAttribute('data-theme')==='dark'?'light':'dark');
    window.purgeChat = () => { if(confirm("NUKE NETWORK?")) { remove(ref(db, 'messages')); remove(ref(db, 'polls')); } };
</script>
</body>
</html>
