<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Wayne Core Supreme Apex</title>
    <style>
        :root {
            --bg: #09090b; --card: #18181b; --text: #fafafa;
            --primary: #a855f7; --my-msg: #a855f7; --other-msg: #27272a;
            --whisper: #eab308; --poll-bg: rgba(168, 85, 247, 0.1);
        }
        [data-theme="light"] {
            --bg: #f4f4f5; --card: #ffffff; --text: #09090b;
            --primary: #7c3aed; --my-msg: #7c3aed; --other-msg: #e4e4e7;
            --poll-bg: rgba(124, 58, 237, 0.1);
        }

        * { box-sizing: border-box; font-family: 'Segoe UI', Tahoma, sans-serif; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; padding: 0; height: 100dvh; background: var(--bg); color: var(--text); overflow: hidden; display: flex; flex-direction: column; }

        header { padding: 15px 20px; background: var(--primary); color: white; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 15px rgba(0,0,0,0.3); z-index: 1000; }
        
        #main-layout { display: flex; flex: 1; overflow: hidden; position: relative; }
        #sidebar { width: 280px; background: rgba(0,0,0,0.25); border-right: 1px solid rgba(255,255,255,0.05); display: flex; flex-direction: column; transition: 0.3s; }
        
        #msg-container { flex: 1; display: flex; flex-direction: column; background: var(--bg); overflow: hidden; }
        #messages { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; }

        .msg-row { display: flex; gap: 12px; margin-bottom: 5px; align-items: flex-end; width: 100%; }
        .mine { flex-direction: row-reverse; }
        .avatar { width: 38px; height: 38px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; color: white; flex-shrink: 0; }
        
        .bubble { max-width: 75%; padding: 12px 16px; border-radius: 20px; font-size: 15px; position: relative; box-shadow: 0 4px 10px rgba(0,0,0,0.2); cursor: pointer; }
        .mine .bubble { background: var(--my-msg); color: white; border-bottom-right-radius: 4px; }
        .theirs .bubble { background: var(--other-msg); color: var(--text); border-bottom-left-radius: 4px; }
        .is-whisper { border: 2px dashed var(--whisper); }
        .reply-quote { background: rgba(0,0,0,0.2); border-left: 3px solid #fff; padding: 6px 10px; margin-bottom: 8px; border-radius: 6px; font-size: 0.75rem; }

        .bubble img { max-width: 100%; max-height: 300px; border-radius: 12px; display: block; margin: 8px 0; }
        
        .poll-card { background: var(--poll-bg); border: 1px solid var(--primary); padding: 15px; border-radius: 15px; margin: 10px 0; }
        .poll-opt { background: rgba(255,255,255,0.05); padding: 10px; margin: 8px 0; border-radius: 10px; cursor: pointer; position: relative; overflow: hidden; }
        .poll-bar { position: absolute; left: 0; top: 0; height: 100%; background: var(--primary); opacity: 0.3; transition: 0.6s; }

        #input-panel { padding: 15px; background: var(--card); border-top: 1px solid rgba(255,255,255,0.1); }
        .preview-bar { display: none; background: rgba(255,255,255,0.05); padding: 10px; border-radius: 10px; margin-bottom: 10px; border-left: 4px solid var(--primary); justify-content: space-between; align-items: center; }

        .toolbar { display: flex; gap: 12px; align-items: center; position: relative; }
        #text-input { flex: 1; border: none; padding: 14px 20px; border-radius: 30px; background: var(--bg); color: var(--text); outline: none; font-size: 16px; }
        .char-counter { position: absolute; right: 60px; bottom: -18px; font-size: 10px; opacity: 0.5; }

        .btn-icon { background: none; border: none; color: var(--primary); font-size: 1.5rem; cursor: pointer; }

        @media (max-width: 850px) {
            #sidebar { position: absolute; left: -280px; z-index: 2000; height: 100%; background: var(--card); }
            #sidebar.open { left: 0; box-shadow: 10px 0 50px rgba(0,0,0,0.5); }
        }

        #login-overlay { position: fixed; inset: 0; background: #000; z-index: 5000; display: flex; align-items: center; justify-content: center; }
        .login-card { background: var(--card); padding: 40px; border-radius: 30px; text-align: center; border: 1px solid var(--primary); width: 90%; max-width: 400px; }
    </style>
</head>
<body data-theme="dark">

<div id="login-overlay">
    <div class="login-card">
        <h1 style="color:var(--primary);">WAYNE CORE</h1>
        <p style="opacity:0.5; font-weight:bold; letter-spacing:2px;">APEX SUPREME V7</p>
        <input type="text" id="user-input" placeholder="Enter Username..." maxlength="15" style="width:100%; padding:18px; border-radius:15px; margin-bottom:20px; background:#000; color:#fff; border:none; text-align:center;">
        <button onclick="login()" style="width:100%; padding:18px; background:var(--primary); color:white; border:none; border-radius:15px; font-weight:bold; cursor:pointer;">JOIN NETWORK</button>
    </div>
</div>

<div id="chat-container">
    <header>
        <div style="display:flex; align-items:center; gap:15px;">
            <button onclick="document.getElementById('sidebar').classList.toggle('open')" style="background:none; border:none; color:white; font-size:1.5rem; cursor:pointer;">‚ò∞</button>
            <span style="font-weight:900; letter-spacing:1px;">WAYNE CORE</span>
        </div>
        <div style="display:flex; gap:10px;">
            <button onclick="requestNotify()" style="background:white; color:black; border:none; padding:5px 12px; border-radius:10px; font-size:10px; font-weight:bold; cursor:pointer;">üîî NOTIFY</button>
            <button onclick="createPoll()" style="background:none; border:1px solid white; color:white; padding:5px; border-radius:5px; font-size:10px; cursor:pointer;">+ POLL</button>
            <button onclick="toggleTheme()" id="thBtn" style="background:none; border:1px solid white; color:white; padding:5px; border-radius:5px; font-size:10px; cursor:pointer;">LIGHT</button>
            <button onclick="purgeChat()" style="color:#ff4444; background:none; border:none; font-size:10px; cursor:pointer; font-weight:bold;">PURGE</button>
        </div>
    </header>

    <div id="main-layout">
        <div id="sidebar">
            <div style="padding:15px; font-weight:bold; color:var(--primary); border-bottom:1px solid rgba(255,255,255,0.05);">ONLINE USERS</div>
            <div id="user-list"></div>
        </div>

        <div id="msg-container">
            <div id="messages"></div>
            <div id="typing-indicator" style="padding:0 20px; font-size:0.8rem; color:var(--primary); height:20px; font-style:italic;"></div>
            
            <div id="input-panel">
                <div id="reply-preview" class="preview-bar">
                    <div id="reply-info" style="font-size:0.8rem;"></div>
                    <button onclick="cancelReply()" style="background:none; border:none; color:white; cursor:pointer;">‚úï</button>
                </div>
                <div id="whisper-preview" class="preview-bar" style="background:var(--whisper); color:#000;">
                    <div id="whisper-info" style="font-size:0.8rem; font-weight:bold;"></div>
                    <button onclick="cancelWhisper()" style="background:none; border:none; color:black; cursor:pointer;">‚úï</button>
                </div>
                
                <form id="chat-form" class="toolbar">
                    <input type="file" id="media-upload" style="display:none" accept="image/*">
                    <button type="button" class="btn-icon" onclick="document.getElementById('media-upload').click()">üñºÔ∏è</button>
                    <button type="button" id="mic-trigger" class="btn-icon">üé§</button>
                    
                    <input id="text-input" placeholder="Type your message..." autocomplete="off" maxlength="500">
                    <span class="char-counter" id="char-count">0/500</span>
                    
                    <button type="submit" class="btn-icon">üöÄ</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, push, onValue, set, remove, onDisconnect } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
    import { getMessaging, getToken, onMessage } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-messaging.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBm_1W_5MRFJEOJZ4-6itgacgSon3DG-H0",
      authDomain: "supreme-chat-22cf4.firebaseapp.com",
      databaseURL: "https://supreme-chat-22cf4-default-rtdb.firebaseio.com",
      projectId: "supreme-chat-22cf4",
      storageBucket: "supreme-chat-22cf4.firebasestorage.app",
      messagingSenderId: "475930341104",
      appId: "1:475930341104:web:f3ee96117523bb914c5c35"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const messaging = getMessaging(app);

    let myUser = localStorage.getItem('wc_apex_user');
    let myColor = localStorage.getItem('wc_apex_color') || '#a855f7';
    let whisperTargetId = null, activeReply = null, mediaRec, audioData = [];
    const myId = "user_" + Math.random().toString(36).substr(2, 9);

    if(myUser) {
        document.getElementById('login-overlay').style.display='none';
        setupPresence();
        initMessages();
        initPolls();
        initTyping();
    }

    window.login = () => {
        const val = document.getElementById('user-input').value.trim();
        if(val) { localStorage.setItem('wc_apex_user', val); location.reload(); }
    };

    // --- NOTIFICATIONS ---
    window.requestNotify = async () => {
        try {
            const permission = await Notification.requestPermission();
            if(permission === 'granted') {
                const token = await getToken(messaging, { 
                    vapidKey: 'BIuY2s439LjkSrsCNNb8CJAfsJDSinl21OctnAtn_sSXl6J6Q--FxwPaC8jFYKW-HJMKfqvmuymGEEdRaAy2H1E' 
                });
                console.log("FCM Token:", token);
                alert("Notifications Active!");
            }
        } catch (e) { alert("Enable HTTPS for notifications."); }
    };

    onMessage(messaging, (payload) => {
        new Notification(payload.notification.title, { body: payload.notification.body });
    });

    // --- CHARACTER COUNT ---
    document.getElementById('text-input').addEventListener('input', (e) => {
        const len = e.target.value.length;
        document.getElementById('char-count').innerText = `${len}/500`;
    });

    // --- PRESENCE & TYPING ---
    function setupPresence() {
        const userRef = ref(db, 'online/' + myId);
        set(userRef, { name: myUser, color: myColor, id: myId });
        onDisconnect(userRef).remove();
        onValue(ref(db, 'online'), (snap) => {
            const users = snap.val() || {};
            document.getElementById('user-list').innerHTML = Object.values(users).map(u => `
                <div onclick="setWhisper('${u.id}', '${u.name}')" style="padding:12px 20px; cursor:pointer; border-bottom:1px solid rgba(255,255,255,0.02); display:flex; align-items:center; gap:10px;">
                    <span style="color:#10b981">‚óè</span> ${u.name} ${u.id === myId ? '(You)' : ''}
                </div>
            `).join('');
        });
    }

    function initTyping() {
        const tRef = ref(db, 'typing/' + myId);
        document.getElementById('text-input').oninput = () => {
            set(tRef, { user: myUser, active: true });
            clearTimeout(window.tTime);
            window.tTime = setTimeout(() => set(tRef, { active: false }), 2000);
        };
        onValue(ref(db, 'typing'), (snap) => {
            const active = Object.values(snap.val()||{}).find(t => t.active && t.user !== myUser);
            document.getElementById('typing-indicator').innerText = active ? active.user + " is typing..." : "";
        });
    }

    // --- MESSAGING LOGIC ---
    function initMessages() {
        onValue(ref(db, 'messages'), (snap) => {
            const container = document.getElementById('messages');
            container.innerHTML = '';
            const data = snap.val();
            if(data) {
                Object.keys(data).forEach(id => {
                    const m = data[id]; m.id = id;
                    if(!m.toId || m.toId === myId || m.senderId === myId) renderMessage(m);
                });
            }
        });
    }

    document.getElementById('chat-form').onsubmit = (e) => {
        e.preventDefault();
        const inp = document.getElementById('text-input');
        if(inp.value.trim()) {
            push(ref(db, 'messages'), {
                type: 'text', content: inp.value, user: myUser, senderId: myId,
                avatarColor: myColor, toId: whisperTargetId, reply: activeReply,
                time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
            });
            inp.value = ''; document.getElementById('char-count').innerText = '0/500';
            cancelWhisper(); cancelReply();
        }
    };

    // --- MEDIA & VOICE ---
    document.getElementById('media-upload').onchange = function() {
        const reader = new FileReader();
        reader.onload = e => push(ref(db, 'messages'), { type: 'image', content: e.target.result, user: myUser, senderId: myId, avatarColor: myColor });
        reader.readAsDataURL(this.files[0]);
    };

    document.getElementById('mic-trigger').onclick = async () => {
        if (!mediaRec || mediaRec.state === "inactive") {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRec = new MediaRecorder(stream);
            mediaRec.ondataavailable = e => audioData.push(e.data);
            mediaRec.onstop = () => {
                const blob = new Blob(audioData, { type: 'audio/webm' });
                const r = new FileReader();
                r.onload = e => push(ref(db, 'messages'), { type: 'audio', content: e.target.result, user: myUser, senderId: myId, avatarColor: myColor });
                r.readAsDataURL(blob); audioData = [];
            };
            mediaRec.start(); document.getElementById('mic-trigger').style.color = '#ff4444';
        } else { mediaRec.stop(); document.getElementById('mic-trigger').style.color = 'var(--primary)'; }
    };

    // --- POLLS ---
    window.createPoll = () => {
        const q = prompt("Question:");
        const o = prompt("Options (comma separated):");
        if(q && o) push(ref(db, 'polls'), { question: q, options: o.split(','), votes: {} });
    };

    function initPolls() {
        onValue(ref(db, 'polls'), (snap) => {
            const polls = snap.val();
            if(polls) Object.keys(polls).forEach(id => renderPoll(id, polls[id]));
        });
    }

    // --- UI RENDERING ---
    function renderMessage(d) {
        const row = document.createElement('div');
        row.className = `msg-row ${d.senderId === myId ? 'mine' : 'theirs'}`;
        let body = d.content;
        if(d.type==='image') body=`<img src="${d.content}">`;
        if(d.type==='audio') body=`<audio controls src="${d.content}" style="max-width:200px;"></audio>`;
        
        row.innerHTML = `
            <div class="avatar" style="background:${d.avatarColor}">${d.user[0]}</div>
            <div class="bubble ${d.toId?'is-whisper':''}" onclick="setReply('${d.user}', '${d.content.substring(0,20)}...')">
                <small style="font-weight:bold; font-size:10px; opacity:0.7; display:block; margin-bottom:4px;">${d.toId?'üîí PRIVATE FROM '+d.user : d.user}</small>
                ${d.reply?`<div class="reply-quote"><b>Replying to:</b> ${d.reply.text}</div>`:''}
                <div>${body}</div>
                <small style="font-size:8px; opacity:0.4; display:block; text-align:right; margin-top:5px;">${d.time || ''}</small>
            </div>
        `;
        document.getElementById('messages').appendChild(row);
        document.getElementById('messages').scrollTop = document.getElementById('messages').scrollHeight;
    }

    function renderPoll(id, p) {
        let div = document.getElementById(id) || document.createElement('div');
        div.className = 'poll-card'; div.id = id;
        const totalVotes = p.votes ? Object.keys(p.votes).length : 0;
        
        div.innerHTML = `<b style="display:block; margin-bottom:10px; color:var(--primary)">üìä ${p.question}</b>` + 
            p.options.map((o, i) => {
                const count = p.votes ? Object.values(p.votes).filter(v => v === i).length : 0;
                const pct = totalVotes ? (count / totalVotes) * 100 : 0;
                return `
                <div class="poll-opt" onclick="votePoll('${id}',${i})">
                    <div class="poll-bar" style="width:${pct}%"></div>
                    <span style="position:relative; z-index:1; display:flex; justify-content:space-between;">
                        <span>${o}</span>
                        <span>${count} (${Math.round(pct)}%)</span>
                    </span>
                </div>`;
            }).join('');
        if(!document.getElementById(id)) document.getElementById('messages').appendChild(div);
    }

    window.votePoll = (id, i) => set(ref(db, `polls/${id}/votes/${myId}`), i);
    window.setWhisper = (id, name) => { whisperTargetId = id; document.getElementById('whisper-preview').style.display='flex'; document.getElementById('whisper-info').innerText = "üîí Whispering to "+name; };
    window.cancelWhisper = () => { whisperTargetId = null; document.getElementById('whisper-preview').style.display='none'; };
    window.setReply = (u, t) => { activeReply = {text: t}; document.getElementById('reply-preview').style.display='flex'; document.getElementById('reply-info').innerText = "Replying to: "+t; };
    window.cancelReply = () => { activeReply = null; document.getElementById('reply-preview').style.display='none'; };
    
    window.toggleTheme = () => {
        const isD = document.body.getAttribute('data-theme') === 'dark';
        document.body.setAttribute('data-theme', isD ? 'light' : 'dark');
        document.getElementById('thBtn').innerText = isD ? 'DARK' : 'LIGHT';
    };

    window.purgeChat = () => { 
        if(confirm("DANGER: Purge all messages and polls?")) { 
            remove(ref(db, 'messages')); 
            remove(ref(db, 'polls')); 
        } 
    };
</script>
</body>
</html>
