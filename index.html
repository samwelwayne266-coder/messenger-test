<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Wayne Core Titan V20</title>
    
    <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
    <style>
        :root {
            --bg: #0b0e14; --card: #1c2128; --text: #e6edf3;
            --primary: #a855f7; --my-msg: #581c87; --other-msg: #2d333b;
            --whisper: #eab308; --danger: #f85149;
        }
        * { box-sizing: border-box; font-family: -apple-system, sans-serif; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; background: var(--bg); color: var(--text); height: 100dvh; display: flex; flex-direction: column; overflow: hidden; }

        header { 
            height: 60px; padding: 0 15px; background: var(--card); border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex; justify-content: space-between; align-items: center; z-index: 100;
        }
        .brand { font-weight: 900; color: var(--primary); letter-spacing: 1px; }

        #main-layout { display: flex; flex: 1; overflow: hidden; position: relative; }
        #sidebar { 
            width: 260px; background: var(--card); border-right: 1px solid rgba(255,255,255,0.1);
            display: flex; flex-direction: column; z-index: 50; transition: transform 0.3s ease;
        }
        @media (max-width: 768px) {
            #sidebar { position: absolute; left: 0; width: 85%; transform: translateX(-100%); height: 100%; box-shadow: 10px 0 30px #000; }
            #sidebar.open { transform: translateX(0); }
        }

        #msg-container { flex: 1; display: flex; flex-direction: column; background: var(--bg); }
        #messages { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 12px; }
        
        .msg-row { display: flex; flex-direction: column; width: 100%; }
        .mine { align-items: flex-end; }
        .theirs { align-items: flex-start; }
        
        .bubble { 
            padding: 10px 14px; border-radius: 18px; font-size: 15px; max-width: 85%;
            position: relative; word-wrap: break-word; line-height: 1.4;
        }
        .mine .bubble { background: var(--my-msg); color: white; border-bottom-right-radius: 2px; }
        .theirs .bubble { background: var(--other-msg); border-bottom-left-radius: 2px; }
        
        .whisper-active { border: 2px solid var(--whisper) !important; box-shadow: 0 0 10px rgba(234, 179, 8, 0.2); }
        .user-label { font-size: 11px; opacity: 0.6; margin-bottom: 2px; font-weight: bold; cursor: pointer; color: var(--primary); }

        #whisper-notice { display: none; background: var(--whisper); color: #000; padding: 8px 15px; font-size: 12px; font-weight: bold; justify-content: space-between; align-items: center; }

        #input-area { background: var(--card); padding: 10px; border-top: 1px solid rgba(255,255,255,0.1); }
        .input-bar { background: var(--bg); border-radius: 25px; display: flex; align-items: center; padding: 5px 15px; border: 1px solid #333; gap: 8px; }
        #text-input { flex: 1; background: transparent; border: none; color: white; padding: 10px 0; outline: none; font-size: 16px; }
        
        .btn-icon { background: none; border: none; font-size: 20px; cursor: pointer; color: var(--primary); display: flex; align-items: center; }
        .recording { color: var(--danger); animation: pulse 1s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        /* POLL DESIGN V2 */
        .poll-card { background: var(--card); border: 1px solid var(--primary); border-radius: 15px; padding: 15px; width: 100%; max-width: 300px; margin: 5px 0; box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
        .poll-opt { 
            position: relative; background: rgba(255,255,255,0.08); margin: 10px 0; border-radius: 10px; 
            cursor: pointer; overflow: hidden; height: 42px; display: flex; align-items: center; 
            padding: 0 15px; font-size: 14px; border: 1px solid rgba(255,255,255,0.1);
        }
        .poll-bar { 
            position: absolute; left: 0; top: 0; bottom: 0; 
            background: linear-gradient(90deg, rgba(168, 85, 247, 0.6), rgba(168, 85, 247, 0.3));
            transition: width 0.6s ease; z-index: 1; 
        }
        .poll-text { position: relative; z-index: 2; display: flex; justify-content: space-between; width: 100%; color: #fff; font-weight: 600; }
    </style>
</head>
<body>

<div id="login-overlay" style="position:fixed; inset:0; background:#000; z-index:9999; display:flex; align-items:center; justify-content:center;">
    <div style="background:var(--card); padding:30px; border-radius:20px; text-align:center; border:1px solid var(--primary); width:90%; max-width:340px;">
        <h2 style="color:var(--primary); margin:0;">Wayne Core</h2>
        <input type="password" id="secret-code" style="width:100%; padding:12px; margin-bottom:10px; border-radius:8px; background:#0b0e14; color:#fff; border:1px solid #333;" placeholder="Secret Code">
        <input type="text" id="username" style="width:100%; padding:12px; margin-bottom:20px; border-radius:8px; background:#0b0e14; color:#fff; border:1px solid #333;" placeholder="Codename">
        <button onclick="login()" style="width:100%; padding:12px; background:var(--primary); color:white; border:none; border-radius:8px; font-weight:bold;">INITIALIZE</button>
    </div>
</div>

<header>
    <button onclick="toggleSidebar()" class="btn-icon">‚ò∞</button>
    <div class="brand">Wayne Core</div>
    <div id="status-dot" style="width:10px; height:10px; background:#2ea043; border-radius:50%;"></div>
</header>

<div id="whisper-notice">
    <span>WHISPERING TO: <span id="target-name"></span></span>
    <span onclick="cancelWhisper()" style="cursor:pointer; padding:5px;">‚úï</span>
</div>

<div id="main-layout">
    <div id="sidebar">
        <div style="padding:20px; border-bottom:1px solid rgba(255,255,255,0.1); color:var(--primary); font-weight:bold; font-size:12px;">ACTIVE NODES</div>
        <div id="user-list" style="flex:1; overflow-y:auto;"></div>
        <div style="padding:15px; display:flex; flex-direction:column; gap:8px;">
            <button onclick="createPoll()" style="width:100%; padding:12px; background:var(--primary); color:white; border:none; border-radius:8px; font-weight:bold; font-size:11px;">+ NEW POLL</button>
            <button onclick="wipeSystem()" style="width:100%; padding:12px; background:var(--danger); color:white; border:none; border-radius:8px; font-weight:bold; font-size:11px;">WIPE SYSTEM</button>
        </div>
    </div>
    
    <div id="msg-container">
        <div id="messages"></div>
        <div id="input-area">
            <div class="input-bar">
                <input type="file" id="img-in" style="display:none" accept="image/*">
                <button onclick="document.getElementById('img-in').click()" class="btn-icon" title="Send Image">üñºÔ∏è</button>
                <button id="mic-btn" class="btn-icon" title="Hold for Voice Chat">üé§</button>
                <input id="text-input" placeholder="Message..." autocomplete="off">
                <button onclick="sendMessage()" style="background:var(--primary); color:white; border:none; padding:10px 18px; border-radius:20px; font-weight:bold;">SEND</button>
            </div>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, push, onChildAdded, onValue, set, remove, onDisconnect } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const config = {
      apiKey: "AIzaSyBm_1W_5MRFJEOJZ4-6itgacgSon3DG-H0",
      authDomain: "supreme-chat-22cf4.firebaseapp.com",
      databaseURL: "https://supreme-chat-22cf4-default-rtdb.firebaseio.com",
      projectId: "supreme-chat-22cf4",
      storageBucket: "supreme-chat-22cf4.firebasestorage.app",
      messagingSenderId: "475930341104",
      appId: "1:475930341104:web:f3ee96117523bb914c5c35"
    };

    const app = initializeApp(config);
    const db = getDatabase(app);
    const myId = "usr_" + Math.random().toString(36).substr(2, 6);
    let myUser = localStorage.getItem('wc_user_v20');
    let whisperTo = null;
    let mediaRecorder;
    let audioChunks = [];

    if(myUser) { document.getElementById('login-overlay').style.display = 'none'; initApp(); }

    window.login = () => {
        const c = document.getElementById('secret-code').value;
        const n = document.getElementById('username').value.trim();
        if(c === "WAYNE" && n) { localStorage.setItem('wc_user_v20', n); location.reload(); }
    };

    function initApp() {
        set(ref(db, 'online/' + myId), { name: myUser });
        onDisconnect(ref(db, 'online/' + myId)).remove();

        onChildAdded(ref(db, 'messages'), snap => {
            renderMsg(snap.key, snap.val());
            const list = document.getElementById('messages');
            list.scrollTop = list.scrollHeight;
        });

        onValue(ref(db, 'online'), snap => {
            const users = snap.val() || {};
            document.getElementById('user-list').innerHTML = Object.entries(users).map(([k,v]) => `
                <div onclick="startWhisper('${k}', '${v.name}')" style="padding:15px; border-bottom:1px solid rgba(255,255,255,0.05); cursor:pointer; font-size:14px;">
                    <span style="color:#2ea043;">‚óè</span> ${v.name} ${k === myId ? '(You)' : ''}
                </div>
            `).join('');
        });

        setupVoice();
        document.getElementById('text-input').onkeydown = (e) => { if(e.key === 'Enter') sendMessage(); };
    }

    function renderMsg(key, m) {
        if(m.whisper && m.whisper !== myId && m.uid !== myId) return;

        const isMine = m.uid === myId;
        const div = document.createElement('div');
        div.className = `msg-row ${isMine ? 'mine' : 'theirs'}`;
        
        let bubbleClass = `bubble ${m.whisper ? 'whisper-active' : ''}`;
        let content = '';

        if(m.type === 'poll') {
            const author = m.user || "System";
            content = `<div class="poll-card" id="poll-${key}">
                        <div style="font-size:11px; opacity:0.6; margin-bottom:5px;">Poll by ${author}</div>
                        <b style="font-size:15px; display:block; margin-bottom:10px;">üìä ${m.q}</b>
                        <div id="opts-${key}">${renderPollOptions(key, m)}</div>
                       </div>`;
            
            onValue(ref(db, `messages/${key}/votes`), () => {
                const optBox = document.getElementById(`opts-${key}`);
                if(optBox) {
                    onValue(ref(db, `messages/${key}`), s => {
                        optBox.innerHTML = renderPollOptions(key, s.val());
                    }, { onlyOnce: true });
                }
            });
        } else if(m.audio) {
            content = `<div class="${bubbleClass}"><audio controls src="${m.audio}" style="width:200px; height:35px;"></audio></div>`;
        } else if(m.img) {
            content = `<div class="${bubbleClass}"><img src="${m.img}" style="max-width:100%; border-radius:10px; display:block;"></div>`;
        } else {
            content = `<div class="user-label" onclick="startWhisper('${m.uid}', '${m.user}')">${m.user}</div>
                       <div class="${bubbleClass}">${m.text}</div>`;
        }
        
        div.innerHTML = content;
        document.getElementById('messages').appendChild(div);
    }

    function renderPollOptions(pollKey, pollData) {
        const votes = pollData.votes || {};
        const total = Object.keys(votes).length;
        return pollData.opts.map((opt, idx) => {
            const count = Object.values(votes).filter(v => v === idx).length;
            const pct = total === 0 ? 0 : Math.round((count / total) * 100);
            return `
                <div class="poll-opt" onclick="vote('${pollKey}', ${idx})">
                    <div class="poll-bar" style="width: ${pct}%"></div>
                    <div class="poll-text">
                        <span>${opt}</span>
                        <span>${pct}%</span>
                    </div>
                </div>`;
        }).join('');
    }

    window.vote = (key, idx) => {
        set(ref(db, `messages/${key}/votes/${myId}`), idx);
    };

    window.sendMessage = () => {
        const inp = document.getElementById('text-input');
        if(!inp.value.trim()) return;
        push(ref(db, 'messages'), {
            text: inp.value, user: myUser, uid: myId,
            whisper: whisperTo, time: Date.now()
        });
        inp.value = '';
    };

    window.startWhisper = (id, name) => {
        if(id === myId) return;
        whisperTo = id;
        document.getElementById('whisper-notice').style.display = 'flex';
        document.getElementById('target-name').innerText = name;
        document.getElementById('text-input').focus();
    };

    window.cancelWhisper = () => { whisperTo = null; document.getElementById('whisper-notice').style.display = 'none'; };

    window.createPoll = () => {
        const q = prompt("Question:");
        const o = prompt("Options (comma separated):");
        if(q && o) {
            push(ref(db, 'messages'), { 
                type: 'poll', 
                q: q, 
                opts: o.split(','), 
                uid: myId, 
                user: myUser, // FIXED: Now correctly passing myUser
                votes: {} 
            });
        }
    };

    window.wipeSystem = () => {
        if(prompt("OVERRIDE CODE:") === "WAYNE") {
            remove(ref(db, 'messages'));
            location.reload();
        }
    };

    window.toggleSidebar = () => document.getElementById('sidebar').classList.toggle('open');

    document.getElementById('img-in').onchange = (e) => {
        const f = e.target.files[0];
        const reader = new FileReader();
        reader.onload = () => push(ref(db, 'messages'), { img: reader.result, user: myUser, uid: myId, whisper: whisperTo });
        reader.readAsDataURL(f);
    };

    function setupVoice() {
        const btn = document.getElementById('mic-btn');
        btn.onmousedown = btn.ontouchstart = async (e) => {
            e.preventDefault();
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
                mediaRecorder.onstop = () => {
                    const blob = new Blob(audioChunks, { type: 'audio/webm' });
                    const reader = new FileReader();
                    reader.onloadend = () => push(ref(db, 'messages'), { audio: reader.result, user: myUser, uid: myId, whisper: whisperTo });
                    reader.readAsDataURL(blob);
                    audioChunks = [];
                };
                mediaRecorder.start();
                btn.classList.add('recording');
            } catch(e) { alert("Microphone access denied."); }
        };
        btn.onmouseup = btn.ontouchend = () => { if(mediaRecorder) mediaRecorder.stop(); btn.classList.remove('recording'); };
    }
</script>
</body>
</html>
