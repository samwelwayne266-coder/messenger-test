<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Wayne Core Supreme Apex</title>
    <style>
        :root {
            --bg: #09090b; --card: #18181b; --text: #fafafa;
            --primary: #a855f7; --my-msg: #a855f7; --other-msg: #27272a;
            --whisper: #eab308; --poll-bg: rgba(168, 85, 247, 0.1);
        }
        [data-theme="light"] {
            --bg: #f4f4f5; --card: #ffffff; --text: #09090b;
            --primary: #7c3aed; --my-msg: #7c3aed; --other-msg: #e4e4e7;
            --poll-bg: rgba(124, 58, 237, 0.1);
        }

        * { box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; padding: 0; height: 100dvh; background: var(--bg); color: var(--text); overflow: hidden; display: flex; flex-direction: column; }

        #messages::-webkit-scrollbar { width: 6px; }
        #messages::-webkit-scrollbar-thumb { background: var(--primary); border-radius: 10px; }
        #chat-container { flex: 1; display: flex; flex-direction: column; width: 100%; max-width: 1400px; margin: 0 auto; background: var(--card); position: relative; overflow: hidden; }

        header { padding: 15px 20px; background: var(--primary); color: white; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 15px rgba(0,0,0,0.3); z-index: 1000; }

        #main-layout { display: flex; flex: 1; overflow: hidden; position: relative; }
        #sidebar { width: 280px; background: rgba(0,0,0,0.25); border-right: 1px solid rgba(255,255,255,0.05); display: flex; flex-direction: column; transition: 0.3s; }
        #msg-container { flex: 1; display: flex; flex-direction: column; position: relative; background: var(--bg); overflow: hidden; }
        #messages { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; }

        .msg-row { display: flex; gap: 12px; margin-bottom: 5px; align-items: flex-end; width: 100%; }
        .mine { flex-direction: row-reverse; }
        .avatar { width: 38px; height: 38px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; color: white; flex-shrink: 0; }
        
        .bubble { max-width: 75%; padding: 12px 16px; border-radius: 20px; font-size: 15px; position: relative; box-shadow: 0 4px 10px rgba(0,0,0,0.2); cursor: pointer; }
        .mine .bubble { background: var(--my-msg); color: white; border-bottom-right-radius: 4px; }
        .theirs .bubble { background: var(--other-msg); color: var(--text); border-bottom-left-radius: 4px; }
        .is-whisper { border: 2px dashed var(--whisper); }

        .reply-quote { background: rgba(0,0,0,0.2); border-left: 3px solid #fff; padding: 6px 10px; margin-bottom: 8px; border-radius: 6px; font-size: 0.75rem; opacity: 0.8; }
        .bubble img { max-width: 100%; max-height: 300px; border-radius: 12px; display: block; margin: 8px 0; }

        .poll-card { background: var(--poll-bg); border: 1px solid var(--primary); padding: 15px; border-radius: 15px; margin: 10px 0; }
        .poll-opt { background: rgba(255,255,255,0.05); padding: 10px; margin: 8px 0; border-radius: 10px; cursor: pointer; position: relative; overflow: hidden; }
        .poll-bar { position: absolute; left: 0; top: 0; height: 100%; background: var(--primary); opacity: 0.3; transition: 0.6s; }

        #input-panel { padding: 15px; background: var(--card); border-top: 1px solid rgba(255,255,255,0.1); }
        .preview-bar { display: none; background: rgba(255,255,255,0.05); padding: 10px; border-radius: 10px; margin-bottom: 10px; justify-content: space-between; align-items: center; border-left: 4px solid var(--primary); }
        
        .toolbar { display: flex; gap: 12px; align-items: center; }
        #text-input { flex: 1; border: none; padding: 14px 20px; border-radius: 30px; background: var(--bg); color: var(--text); outline: none; }
        .btn-icon { background: none; border: none; color: var(--primary); font-size: 1.5rem; cursor: pointer; }

        @media (max-width: 850px) {
            #sidebar { position: absolute; left: -280px; z-index: 2000; height: 100%; background: var(--card); }
            #sidebar.open { left: 0; box-shadow: 10px 0 50px rgba(0,0,0,0.8); }
        }

        #login-overlay { position: fixed; inset: 0; background: #000; z-index: 5000; display: flex; align-items: center; justify-content: center; }
        .login-card { background: var(--card); padding: 40px; border-radius: 30px; text-align: center; border: 1px solid var(--primary); width: 90%; max-width: 400px; }
    </style>
</head>
<body data-theme="dark">

<div id="login-overlay">
    <div class="login-card">
        <h1 style="color:var(--primary);">WAYNE CORE</h1>
        <input type="text" id="user-input" placeholder="Enter Username..." maxlength="15" style="width:100%; padding:15px; border-radius:10px; margin-bottom:20px;">
        <button onclick="login()" style="width:100%; padding:15px; background:var(--primary); color:white; border:none; border-radius:10px; font-weight:bold;">JOIN NETWORK</button>
    </div>
</div>

<div id="chat-container">
    <header>
        <div style="display:flex; align-items:center; gap:15px;">
            <button onclick="document.getElementById('sidebar').classList.toggle('open')" style="background:none; border:none; color:white; font-size:1.5rem;">‚ò∞</button>
            <span style="font-weight:900;">WAYNE CORE</span>
        </div>
        <div style="display:flex; gap:10px;">
            <button onclick="requestNotify()" style="background:none; border:1px solid white; color:white; padding:5px; border-radius:5px; font-size:10px;">NOTIFY</button>
            <button onclick="createPoll()" style="background:none; border:1px solid white; color:white; padding:5px; border-radius:5px; font-size:10px;">+POLL</button>
            <button onclick="toggleTheme()" id="thBtn" style="background:none; border:1px solid white; color:white; padding:5px; border-radius:5px; font-size:10px;">LIGHT</button>
            <button onclick="purgeChat()" style="color:red; background:none; border:none; font-size:10px;">PURGE</button>
        </div>
    </header>

    <div id="main-layout">
        <div id="sidebar">
            <div style="padding:15px; font-weight:bold; color:var(--primary);">ONLINE</div>
            <div id="user-list"></div>
        </div>
        <div id="msg-container">
            <div id="messages"></div>
            <div id="typing-indicator" style="padding:0 20px; font-size:0.8rem; color:var(--primary); height:20px;"></div>
            <div id="input-panel">
                <div id="reply-preview" class="preview-bar">
                    <div id="reply-info"></div>
                    <button onclick="cancelReply()">‚úï</button>
                </div>
                <div id="whisper-preview" class="preview-bar" style="background:var(--whisper); color:#000;">
                    <div id="whisper-info"></div>
                    <button onclick="cancelWhisper()">‚úï</button>
                </div>
                <form id="chat-form" class="toolbar">
                    <input type="file" id="media-upload" style="display:none" accept="image/*">
                    <button type="button" class="btn-icon" onclick="document.getElementById('media-upload').click()">üñºÔ∏è</button>
                    <button type="button" id="mic-trigger" class="btn-icon">üé§</button>
                    <input id="text-input" placeholder="Type..." autocomplete="off">
                    <button type="submit" class="btn-icon">üöÄ</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, push, onValue, set, remove, onDisconnect, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
    import { getMessaging, getToken, onMessage } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-messaging.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBm_1W_5MRFJEOJZ4-6itgacgSon3DG-H0",
      authDomain: "supreme-chat-22cf4.firebaseapp.com",
      databaseURL: "https://supreme-chat-22cf4-default-rtdb.firebaseio.com",
      projectId: "supreme-chat-22cf4",
      storageBucket: "supreme-chat-22cf4.firebasestorage.app",
      messagingSenderId: "475930341104",
      appId: "1:475930341104:web:f3ee96117523bb914c5c35"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const messaging = getMessaging(app);

    let myUser = localStorage.getItem('wc_apex_user');
    let myColor = localStorage.getItem('wc_apex_color') || '#a855f7';
    let whisperTargetId = null, activeReply = null, mediaRec, audioData = [];
    const myId = "user_" + Math.random().toString(36).substr(2, 9);

    if(myUser) {
        document.getElementById('login-overlay').style.display='none';
        setupPresence();
        initMessages();
        initPolls();
        initTyping();
    }

    window.login = () => {
        const val = document.getElementById('user-input').value.trim();
        if(val) { localStorage.setItem('wc_apex_user', val); location.reload(); }
    };

    // --- NOTIFICATIONS ---
    window.requestNotify = async () => {
        const permission = await Notification.requestPermission();
        if(permission === 'granted') {
            const token = await getToken(messaging, { vapidKey: 'BIuY2s439LjkSrsCNNb8CJAfsJDSinl21OctnAtn_sSXl6J6Q--FxwPaC8jFYKW-HJMKfqvmuymGEEdRaAy2H1E' });
            console.log("Token:", token);
            alert("Notifications Active!");
        }
    };

    onMessage(messaging, (payload) => {
        new Notification(payload.notification.title, { body: payload.notification.body });
    });

    // --- PRESENCE ---
    function setupPresence() {
        const userRef = ref(db, 'online/' + myId);
        set(userRef, { name: myUser, color: myColor, id: myId });
        onDisconnect(userRef).remove();
        onValue(ref(db, 'online'), (snap) => {
            const users = snap.val() || {};
            document.getElementById('user-list').innerHTML = Object.values(users).map(u => `
                <div onclick="setWhisper('${u.id}', '${u.name}')" style="padding:10px 20px; cursor:pointer; border-bottom:1px solid #333;">üü¢ ${u.name}</div>
            `).join('');
        });
    }

    // --- MESSAGES ---
    function initMessages() {
        onValue(ref(db, 'messages'), (snap) => {
            document.getElementById('messages').innerHTML = '';
            const data = snap.val();
            if(data) {
                Object.keys(data).forEach(id => {
                    const m = data[id]; m.id = id;
                    if(!m.toId || m.toId === myId || m.senderId === myId) renderMessage(m);
                });
            }
        });
    }

    document.getElementById('chat-form').onsubmit = (e) => {
        e.preventDefault();
        const inp = document.getElementById('text-input');
        if(inp.value.trim()) {
            push(ref(db, 'messages'), {
                type: 'text', content: inp.value, user: myUser, senderId: myId,
                avatarColor: myColor, toId: whisperTargetId, reply: activeReply,
                time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
            });
            inp.value = ''; cancelWhisper(); cancelReply();
        }
    };

    // --- FEATURES: IMAGES, VOICE, POLLS, THEME ---
    document.getElementById('media-upload').onchange = function() {
        const reader = new FileReader();
        reader.onload = e => push(ref(db, 'messages'), { type: 'image', content: e.target.result, user: myUser, senderId: myId, avatarColor: myColor });
        reader.readAsDataURL(this.files[0]);
    };

    document.getElementById('mic-trigger').onclick = async () => {
        if (!mediaRec || mediaRec.state === "inactive") {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRec = new MediaRecorder(stream);
            mediaRec.ondataavailable = e => audioData.push(e.data);
            mediaRec.onstop = () => {
                const blob = new Blob(audioData, { type: 'audio/webm' });
                const r = new FileReader();
                r.onload = e => push(ref(db, 'messages'), { type: 'audio', content: e.target.result, user: myUser, senderId: myId, avatarColor: myColor });
                r.readAsDataURL(blob); audioData = [];
            };
            mediaRec.start(); document.getElementById('mic-trigger').style.color = 'red';
        } else { mediaRec.stop(); document.getElementById('mic-trigger').style.color = 'var(--primary)'; }
    };

    window.createPoll = () => {
        const q = prompt("Question:"), o = prompt("Options (comma separated):");
        if(q && o) push(ref(db, 'polls'), { question: q, options: o.split(','), votes: {} });
    };

    function initPolls() {
        onValue(ref(db, 'polls'), (snap) => {
            const polls = snap.val();
            if(polls) Object.keys(polls).forEach(id => renderPoll(id, polls[id]));
        });
    }

    function initTyping() {
        const tRef = ref(db, 'typing/' + myId);
        document.getElementById('text-input').oninput = () => {
            set(tRef, { user: myUser, active: true });
            clearTimeout(window.tTime);
            window.tTime = setTimeout(() => set(tRef, { active: false }), 2000);
        };
        onValue(ref(db, 'typing'), (snap) => {
            const active = Object.values(snap.val()||{}).find(t => t.active && t.user !== myUser);
            document.getElementById('typing-indicator').innerText = active ? active.user + " is typing..." : "";
        });
    }

    window.toggleTheme = () => {
        const isD = document.body.getAttribute('data-theme') === 'dark';
        document.body.setAttribute('data-theme', isD ? 'light' : 'dark');
        document.getElementById('thBtn').innerText = isD ? 'DARK' : 'LIGHT';
    };

    // --- UI RENDERING ---
    function renderMessage(d) {
        const row = document.createElement('div');
        row.className = `msg-row ${d.senderId === myId ? 'mine' : 'theirs'}`;
        let body = d.content;
        if(d.type==='image') body=`<img src="${d.content}">`;
        if(d.type==='audio') body=`<audio controls src="${d.content}"></audio>`;
        row.innerHTML = `
            <div class="avatar" style="background:${d.avatarColor}">${d.user[0]}</div>
            <div class="bubble ${d.toId?'is-whisper':''}" onclick="setReply('${d.user}', '${d.content}')">
                <small>${d.toId?'üîí PRIVATE':d.user}</small>
                ${d.reply?`<div class="reply-quote">${d.reply.text}</div>`:''}
                <div>${body}</div>
            </div>
        `;
        document.getElementById('messages').appendChild(row);
        document.getElementById('messages').scrollTop = document.getElementById('messages').scrollHeight;
    }

    function renderPoll(id, p) {
        let div = document.getElementById(id) || document.createElement('div');
        div.className = 'poll-card'; div.id = id;
        div.innerHTML = `<b>${p.question}</b>` + p.options.map((o, i) => `<div class="poll-opt" onclick="votePoll('${id}',${i})">${o}</div>`).join('');
        if(!document.getElementById(id)) document.getElementById('messages').appendChild(div);
    }

    window.votePoll = (id, i) => set(ref(db, `polls/${id}/votes/${myId}`), i);
    window.setWhisper = (id, name) => { whisperTargetId = id; document.getElementById('whisper-preview').style.display='flex'; document.getElementById('whisper-info').innerText = "Whisper to "+name; };
    window.cancelWhisper = () => { whisperTargetId = null; document.getElementById('whisper-preview').style.display='none'; };
    window.setReply = (u, t) => { activeReply = {text: t}; document.getElementById('reply-preview').style.display='flex'; document.getElementById('reply-info').innerText = "Reply to "+u; };
    window.cancelReply = () => { activeReply = null; document.getElementById('reply-preview').style.display='none'; };
    window.purgeChat = () => { if(confirm("Purge?")) { remove(ref(db, 'messages')); remove(ref(db, 'polls')); } };
</script>
</body>
</html>

