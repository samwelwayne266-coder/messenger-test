<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <title>Wayne Core</title>
    <link rel="shortcut icon" href="./favicon.ico" type="image/x-icon">
    <link rel="manifest" href="manifest.json">
    
    <meta name="apple-mobile-web-app-title" content="Wayne Core">
    <meta name="application-name" content="Wayne Core">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0b0e14">

    <link rel="manifest" href="data:application/manifest+json,{%22name%22:%22Wayne%20Core%22,%22short_name%22:%22WayneCore%22,%22start_url%22:%22.%22,%22display%22:%22standalone%22,%22background_color%22:%22#0b0e14%22,%22theme_color%22:%22#a855f7%22,%22icons%22:[{%22src%22:%22https://cdn-icons-png.flaticon.com/512/940/940193.png%22,%22sizes%22:%22512x512%22,%22type%22:%22image/png%22}]}">

    <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>

    <style>
        :root {
            --bg: #0b0e14; --card: #1c2128; --text: #e6edf3;
            --primary: #a855f7; --my-msg: #581c87; --other-msg: #2d333b;
            --whisper: #eab308; --danger: #f85149;
        }
        * { box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; background: var(--bg); color: var(--text); height: 100dvh; display: flex; flex-direction: column; overflow: hidden; }

        /* SPLASH SCREEN & DIAGNOSTICS */
        #splash-screen {
            position: fixed; inset: 0; background: var(--bg); z-index: 10000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: opacity 0.8s ease;
        }
        .splash-logo { width: 80px; height: 80px; background: var(--primary); border-radius: 20px; box-shadow: 0 0 40px rgba(168, 85, 247, 0.4); margin-bottom: 20px; animation: pulse 2s infinite; }
        #diag-text { font-family: monospace; font-size: 11px; color: var(--primary); letter-spacing: 2px; }

        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); opacity: 0.8; } 100% { transform: scale(1); } }

        /* LOGIN OVERLAY */
        #login-overlay {
            position: fixed; inset: 0; background: #000; z-index: 9999;
            display: none; align-items: center; justify-content: center;
        }
        .login-card { background: var(--card); padding: 30px; border-radius: 20px; text-align: center; border: 1px solid var(--primary); width: 90%; max-width: 340px; }

        /* HEADER */
        header { 
            height: 60px; padding: 0 15px; background: var(--card); border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex; justify-content: space-between; align-items: center; z-index: 100;
        }
        .brand { font-weight: 900; color: var(--primary); letter-spacing: 2px; font-size: 18px; }

        /* LAYOUT & SIDEBAR */
        #main-layout { display: flex; flex: 1; overflow: hidden; position: relative; }
        #sidebar { 
            width: 260px; background: var(--card); border-right: 1px solid rgba(255,255,255,0.1);
            display: flex; flex-direction: column; z-index: 50; transition: transform 0.3s ease;
        }
        @media (max-width: 768px) {
            #sidebar { position: absolute; left: 0; width: 85%; transform: translateX(-100%); height: 100%; box-shadow: 10px 0 30px #000; }
            #sidebar.open { transform: translateX(0); }
        }

        /* MESSAGES */
        #msg-container { flex: 1; display: flex; flex-direction: column; background: var(--bg); }
        #messages { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 12px; }
        .msg-row { display: flex; flex-direction: column; width: 100%; }
        .mine { align-items: flex-end; }
        .theirs { align-items: flex-start; }
        
        .bubble { padding: 10px 14px; border-radius: 18px; font-size: 15px; max-width: 85%; position: relative; word-wrap: break-word; line-height: 1.4; }
        .mine .bubble { background: var(--my-msg); color: white; border-bottom-right-radius: 2px; }
        .theirs .bubble { background: var(--other-msg); border-bottom-left-radius: 2px; }
        
        .whisper-active { border: 2px solid var(--whisper) !important; box-shadow: 0 0 10px rgba(234, 179, 8, 0.2); }
        .user-label { font-size: 11px; opacity: 0.6; margin-bottom: 2px; font-weight: bold; cursor: pointer; color: var(--primary); }

        #whisper-notice { display: none; background: var(--whisper); color: #000; padding: 8px 15px; font-size: 12px; font-weight: bold; justify-content: space-between; align-items: center; }

        /* INPUT AREA */
        #input-area { background: var(--card); padding: 10px; border-top: 1px solid rgba(255,255,255,0.1); padding-bottom: max(10px, env(safe-area-inset-bottom)); }
        .input-bar { background: var(--bg); border-radius: 25px; display: flex; align-items: center; padding: 5px 15px; border: 1px solid #333; gap: 8px; }
        #text-input { flex: 1; background: transparent; border: none; color: white; padding: 10px 0; outline: none; font-size: 16px; }
        .btn-icon { background: none; border: none; font-size: 20px; cursor: pointer; color: var(--primary); display: flex; align-items: center; }
        .recording { color: var(--danger); animation: pulse 1s infinite; }

        /* POLLS */
        .poll-card { background: var(--card); border: 1px solid var(--primary); border-radius: 15px; padding: 15px; width: 100%; max-width: 300px; margin: 5px 0; }
        .poll-opt { position: relative; background: rgba(255,255,255,0.08); margin: 8px 0; border-radius: 10px; cursor: pointer; overflow: hidden; height: 42px; display: flex; align-items: center; padding: 0 15px; }
        .poll-bar { position: absolute; left: 0; top: 0; bottom: 0; background: rgba(168, 85, 247, 0.4); transition: width 0.6s ease; z-index: 1; }
        .poll-text { position: relative; z-index: 2; display: flex; justify-content: space-between; width: 100%; color: #fff; font-weight: 600; text-shadow: 0 1px 2px #000; }
    </style>
</head>
<body>

<div id="splash-screen">
    <div class="splash-logo"></div>
    <div id="diag-text">SYNCING WAYNE CORE...</div>
</div>

<div id="login-overlay">
    <div class="login-card">
        <h2 style="color:var(--primary); margin:0 0 20px 0;">Wayne Core</h2>
        <input type="password" id="secret-code" style="width:100%; padding:12px; margin-bottom:10px; border-radius:8px; background:#0b0e14; color:#fff; border:1px solid #333;" placeholder="Secret Code">
        <input type="text" id="username" style="width:100%; padding:12px; margin-bottom:20px; border-radius:8px; background:#0b0e14; color:#fff; border:1px solid #333;" placeholder="Node Name">
        <button onclick="login()" style="width:100%; padding:12px; background:var(--primary); color:white; border:none; border-radius:8px; font-weight:bold;">INITIALIZE</button>
    </div>
</div>

<header>
    <button onclick="toggleSidebar()" class="btn-icon">‚ò∞</button>
    <div class="brand">Wayne Core</div>
    <div id="status-dot" style="width:10px; height:10px; background:#2ea043; border-radius:50%;"></div>
</header>

<div id="whisper-notice">
    <span>WHISPERING TO: <span id="target-name"></span></span>
    <span onclick="cancelWhisper()" style="cursor:pointer; padding:5px;">‚úï</span>
</div>

<div id="main-layout">
    <div id="sidebar">
        <div style="padding:20px; border-bottom:1px solid rgba(255,255,255,0.1); color:var(--primary); font-weight:bold; font-size:12px;">ACTIVE NODES</div>
        <div id="user-list" style="flex:1; overflow-y:auto;"></div>
        <div style="padding:15px; display:flex; flex-direction:column; gap:8px;">
            <button onclick="createPoll()" style="width:100%; padding:12px; background:var(--primary); color:white; border:none; border-radius:8px; font-weight:bold; font-size:11px;">+ NEW POLL</button>
            <button onclick="wipeSystem()" style="width:100%; padding:12px; background:var(--danger); color:white; border:none; border-radius:8px; font-weight:bold; font-size:11px;">WIPE SYSTEM</button>
        </div>
    </div>
    
    <div id="msg-container">
        <div id="messages"></div>
        <div id="input-area">
            <div class="input-bar">
                <input type="file" id="img-in" style="display:none" accept="image/*">
                <button onclick="document.getElementById('img-in').click()" class="btn-icon">üñºÔ∏è</button>
                <button id="mic-btn" class="btn-icon">üé§</button>
                <input id="text-input" placeholder="Secure Message..." autocomplete="off">
                <button onclick="sendMessage()" style="background:var(--primary); color:white; border:none; padding:10px 18px; border-radius:20px; font-weight:bold;">SEND</button>
            </div>
        </div>
    </div>
</div>

<script type="module">
/* ================= IMPORT FIREBASE ================= */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, push, onChildAdded, onValue, set, remove, onDisconnect, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

/* ================= HELPER ================= */
const $ = id => document.getElementById(id);

/* ================= DOM ELEMENTS ================= */
const splashScreen  = $("splash-screen");
const loginOverlay  = $("login-overlay");
const secretInput   = $("secret-code");
const usernameInput = $("username");
const userList      = $("user-list");
const messagesBox   = $("messages");
const textInput     = $("text-input");
const micBtn        = $("mic-btn");
const statusDot     = $("status-dot");
const whisperNotice = $("whisper-notice");
const targetName    = $("target-name");
const sidebar       = $("sidebar");

/* ================= FIREBASE ================= */
const firebaseConfig = {
  apiKey: "AIzaSyBm_1W_5MRFJEOJZ4-6itgacgSon3DG-H0",
  authDomain: "supreme-chat-22cf4.firebaseapp.com",
  databaseURL: "https://supreme-chat-22cf4-default-rtdb.firebaseio.com",
  projectId: "supreme-chat-22cf4",
  storageBucket: "supreme-chat-22cf4.appspot.com",
  messagingSenderId: "475930341104",
  appId: "1:475930341104:web:f3ee96117523bb914c5c35"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

/* ================= USER ================= */
let myId = localStorage.getItem("wc_uid") || ("u_" + Math.random().toString(36).slice(2, 10));
localStorage.setItem("wc_uid", myId);
let myUser = localStorage.getItem("wc_user");
let whisperTo = null;
const rendered = new Set();
const typingNodes = {};
const messageQueue = [];

/* ================= SPLASH ================= */
window.onload = () => {
  setTimeout(() => {
    splashScreen.style.opacity = "0";
    setTimeout(() => {
      splashScreen.style.display = "none";
      if (!myUser) loginOverlay.style.display = "flex";
      else init();
    }, 800);
  }, 1800);
};

/* ================= LOGIN ================= */
window.login = () => {
  if (secretInput.value === "WAYNE" && usernameInput.value.trim()) {
    localStorage.setItem("wc_user", usernameInput.value.trim());
    location.reload();
  }
};

/* ================= INIT ================= */
function init() {
  set(ref(db, "online/" + myId), { name: myUser, avatar: "https://cdn-icons-png.flaticon.com/512/940/940193.png", role: "user", status: "online" });
  onDisconnect(ref(db, "online/" + myId)).remove();

  setupUsers();
  setupMessages();
  setupTyping();
  setupVoice();
  setupOfflineQueue();
}

/* ================= USERS ================= */
function setupUsers() {
  onValue(ref(db, "online"), snap => {
    const users = snap.val() || {};
    userList.innerHTML = Object.entries(users).map(([id, u]) => `
      <div onclick="startWhisper('${id}','${u.name}')">
        <img src="${u.avatar}" style="width:20px;height:20px;border-radius:50%;"> ${u.name} ${id===myId?"(You)":""} [${u.status}]
      </div>
    `).join("");
  });
}

/* ================= MESSAGES ================= */
function setupMessages() {
  onChildAdded(ref(db, "messages"), snap => {
    if (!rendered.has(snap.key)) {
      rendered.add(snap.key);
      renderMessage(snap.val(), snap.key);
    }
  });
}

function renderMessage(m, id) {
  if (m.whisper && m.whisper !== myId && m.uid !== myId) return;

  const row = document.createElement("div");
  row.className = m.uid === myId ? "msg mine" : "msg";

  let bubble = `
    ${m.text ? `<div class="bubble">${m.text}</div>` : ""}
    ${m.img ? `<img src="${m.img}" style="max-width:100%;border-radius:8px;">` : ""}
    ${m.audio ? `<audio controls src="${m.audio}"></audio>` : ""}
    ${m.type === "poll" ? `<div class="poll"><b>${m.q}</b><div id="poll-${id}"></div></div>` : ""}
    <div class="time">${new Date(m.time).toLocaleTimeString()}</div>
  `;

  row.innerHTML = `<div class="user" onclick="startWhisper('${m.uid}','${m.user}')">${m.user}</div>${bubble}`;

  messagesBox.appendChild(row);
  messagesBox.scrollTop = messagesBox.scrollHeight;

  if (m.type === "poll") watchPoll(id);
}

/* ================= POLLS ================= */
function watchPoll(id) {
  onValue(ref(db, "messages/" + id), snap => {
    const m = snap.val();
    if (!m) return;
    const box = $("poll-" + id);
    box.innerHTML = m.opts.map((o, i) => `
      <button onclick="vote('${id}',${i})">${o} (${m.votes?Object.values(m.votes).filter(v=>v===i).length:0})</button>
    `).join("");
  });
}

window.vote = (id, i) => set(ref(db, `messages/${id}/votes/${myId}`), i);

window.createPoll = () => {
  const q = prompt("Poll question?");
  if (!q) return;

  const opts = [];
  while (true) {
    const o = prompt("Add option (Cancel to stop)");
    if (!o) break;
    opts.push(o);
  }
  if (opts.length < 2) return alert("At least 2 options.");

  push(ref(db, "messages"), {
    type: "poll", q, opts, votes: {},
    uid: myId, user: myUser, time: Date.now()
  });
};

/* ================= SEND ================= */
window.sendMessage = () => {
  if (!textInput.value.trim()) return;
  const msg = {
    text: textInput.value,
    uid: myId,
    user: myUser,
    whisper: whisperTo,
    time: Date.now(),
    reactions: {},
    delivered: false,
    seen: false
  };

  push(ref(db, "messages"), msg).then(() => { textInput.value = ""; });
};

/* ================= WHISPER ================= */
window.startWhisper = (id, name) => {
  whisperTo = id;
  whisperNotice.style.display = "flex";
  targetName.textContent = name;
};

window.cancelWhisper = () => {
  whisperTo = null;
  whisperNotice.style.display = "none";
};

/* ================= TYPING ================= */
function setupTyping() {
  const tRef = ref(db, "typing/" + myId);
  textInput.addEventListener("input", () => {
    set(tRef, myUser);
    setTimeout(() => remove(tRef), 1200);
  });

  onValue(ref(db, "typing"), snap => {
    const active = Object.values(snap.val() || {}).filter(n => n !== myUser);
    statusDot.style.background = active.length ? "#eab308" : "#22c55e";
  });
}

/* ================= VOICE ================= */
function setupVoice() {
  let rec, chunks;
  micBtn.onmousedown = async () => {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    rec = new MediaRecorder(stream);
    chunks = [];
    rec.ondataavailable = e => chunks.push(e.data);
    rec.onstop = () => {
      const blob = new Blob(chunks, { type: "audio/webm" });
      const r = new FileReader();
      r.onload = () => push(ref(db, "messages"), {
        audio: r.result,
        uid: myId,
        user: myUser,
        time: Date.now(),
        whisper: whisperTo
      });
      r.readAsDataURL(blob);
    };
    rec.start();
  };
  micBtn.onmouseup = () => rec?.stop();
}

/* ================= SIDEBAR ================= */
window.toggleSidebar = () => sidebar.classList.toggle("open");

/* ================= WIPE ================= */
window.wipeSystem = () => {
  if (prompt("ADMIN OVERRIDE:") === "WAYNE") remove(ref(db, "messages"));
};

/* ================= OFFLINE ================= */
function setupOfflineQueue() {
  // Queue messages if offline
  window.addEventListener("offline", () => console.log("You are offline."));
  window.addEventListener("online", () => {
    while (messageQueue.length) {
      push(ref(db, "messages"), messageQueue.shift());
    }
  });
}
</script>
</body>
</html>





