<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Wayne Core Titan</title>
    
    <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
    <script>
      window.OneSignalDeferred = window.OneSignalDeferred || [];
      OneSignalDeferred.push(async function(OneSignal) {
        await OneSignal.init({ appId: "3504bc48-2267-4c0b-817d-faf41d5057c2" });
      });
    </script>

    <style>
        :root {
            --bg: #09090b; --card: #18181b; --text: #fafafa;
            --primary: #a855f7; --my-msg: #a855f7; --other-msg: #27272a;
            --whisper: #eab308; --danger: #ef4444;
        }
        [data-theme="light"] {
            --bg: #f4f4f5; --card: #ffffff; --text: #09090b;
            --primary: #7c3aed; --my-msg: #7c3aed; --other-msg: #e4e4e7;
        }
        * { box-sizing: border-box; font-family: 'Inter', system-ui, sans-serif; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; background: var(--bg); color: var(--text); height: 100dvh; display: flex; flex-direction: column; overflow: hidden; }
        
        /* Glassmorphism Header */
        header { 
            padding: 15px 20px; 
            background: rgba(168, 85, 247, 0.8); 
            backdrop-filter: blur(10px);
            display: flex; justify-content: space-between; align-items: center; 
            z-index: 1000; border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        #main-layout { display: flex; flex: 1; overflow: hidden; }
        
        /* Expandable Sidebar */
        #sidebar { 
            width: 280px; background: rgba(0,0,0,0.2); 
            border-right: 1px solid rgba(255,255,255,0.05); 
            display: flex; flex-direction: column; transition: 0.3s;
        }

        /* Message Area */
        #msg-container { flex: 1; display: flex; flex-direction: column; position: relative; }
        #messages { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 12px; }
        
        .msg-row { display: flex; gap: 10px; margin-bottom: 4px; align-items: flex-end; }
        .mine { flex-direction: row-reverse; }
        
        .bubble { 
            max-width: 75%; padding: 12px 16px; border-radius: 20px; 
            font-size: 15px; position: relative; transition: transform 0.2s;
            cursor: pointer;
        }
        .mine .bubble { background: var(--my-msg); border-bottom-right-radius: 4px; color: white; }
        .theirs .bubble { background: var(--other-msg); border-bottom-left-radius: 4px; }
        
        /* Reactions */
        .reactions { 
            display: flex; gap: 4px; margin-top: -8px; margin-left: 10px;
            background: var(--card); border-radius: 10px; padding: 2px 6px;
            font-size: 12px; border: 1px solid rgba(255,255,255,0.1);
            width: fit-content;
        }

        /* Input Panel */
        #input-panel { padding: 15px; background: var(--card); border-top: 1px solid rgba(255,255,255,0.1); }
        .toolbar { display: flex; gap: 10px; align-items: center; }
        #text-input { 
            flex: 1; padding: 12px 18px; border-radius: 25px; 
            border: none; background: var(--bg); color: white; outline: none; 
        }
        
        .btn-icon { background: none; border: none; color: var(--primary); font-size: 1.4rem; cursor: pointer; opacity: 0.8; }
        .btn-icon:hover { opacity: 1; transform: scale(1.1); }

        /* Overlays */
        #login-overlay { position: fixed; inset: 0; background: #000; z-index: 5000; display: flex; align-items: center; justify-content: center; }
        .login-card { background: var(--card); padding: 40px; border-radius: 25px; text-align: center; border: 1px solid var(--primary); width: 90%; max-width: 380px; }
        
        audio { height: 35px; width: 200px; margin-top: 5px; border-radius: 10px; }
    </style>
</head>
<body data-theme="dark">

<div id="login-overlay">
    <div class="login-card">
        <h1 style="color:var(--primary); margin-bottom: 5px;">WAYNE CORE</h1>
        <p style="font-size: 12px; opacity: 0.6; margin-bottom: 25px;">TITAN PROTOCOL V8</p>
        <input type="password" id="secret-input" placeholder="Secret Key (WAYNE)" style="width:100%; padding:15px; border-radius:12px; margin-bottom:10px; background:#000; color:#fff; border:1px solid #333; text-align:center;">
        <input type="text" id="user-input" placeholder="Display Name" maxlength="12" style="width:100%; padding:15px; border-radius:12px; margin-bottom:20px; background:#000; color:#fff; border:1px solid #333; text-align:center;">
        <button onclick="login()" style="width:100%; padding:15px; background:var(--primary); color:white; border:none; border-radius:12px; font-weight:bold; cursor:pointer;">AUTHENTICATE</button>
    </div>
</div>

<header>
    <div style="display:flex; align-items:center; gap:12px;">
        <div id="online-indicator" style="width:10px; height:10px; background:#10b981; border-radius:50%; box-shadow: 0 0 10px #10b981;"></div>
        <span style="font-weight:900; letter-spacing:1.5px; text-transform:uppercase;">Wayne Core</span>
    </div>
    <div style="display:flex; gap:15px;">
        <button onclick="toggleTheme()" class="btn-icon" style="font-size: 1rem;">üåì</button>
        <button onclick="purgeChat()" style="color:white; background:var(--danger); border:none; padding: 5px 10px; border-radius:5px; font-size:10px; font-weight:bold; cursor:pointer;">PURGE</button>
    </div>
</header>

<div id="main-layout">
    <div id="sidebar">
        <div style="padding:20px; font-size:12px; font-weight:bold; color:var(--primary); border-bottom: 1px solid rgba(255,255,255,0.05);">ACTIVE USERS</div>
        <div id="user-list" style="flex:1; overflow-y:auto;"></div>
    </div>
    
    <div id="msg-container">
        <div id="messages"></div>
        <div id="typing-indicator" style="padding:5px 20px; font-size:11px; color:var(--primary); font-style:italic; height:20px;"></div>
        
        <div id="input-panel">
            <div id="preview-area" style="display:none; padding-bottom:10px; font-size:12px; color:var(--primary); display:flex; justify-content:space-between;">
                <span id="preview-text"></span>
                <button onclick="cancelAction()" style="background:none; border:none; color:var(--danger); cursor:pointer;">‚úï</button>
            </div>
            <form id="chat-form" class="toolbar">
                <input type="file" id="file-input" style="display:none" accept="image/*">
                <button type="button" class="btn-icon" onclick="document.getElementById('file-input').click()">üñºÔ∏è</button>
                <button type="button" id="record-btn" class="btn-icon">üéôÔ∏è</button>
                <input id="text-input" placeholder="Type a secure message..." autocomplete="off">
                <button type="submit" class="btn-icon">üöÄ</button>
            </form>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, push, onValue, set, remove, onDisconnect, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBm_1W_5MRFJEOJZ4-6itgacgSon3DG-H0",
      authDomain: "supreme-chat-22cf4.firebaseapp.com",
      databaseURL: "https://supreme-chat-22cf4-default-rtdb.firebaseio.com",
      projectId: "supreme-chat-22cf4",
      storageBucket: "supreme-chat-22cf4.firebasestorage.app",
      messagingSenderId: "475930341104",
      appId: "1:475930341104:web:f3ee96117523bb914c5c35"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    
    const SECRET = "WAYNE";
    let myUser = localStorage.getItem('wc_apex_user');
    let myColor = localStorage.getItem('wc_apex_color') || '#' + Math.floor(Math.random()*16777215).toString(16);
    const myId = "uid_" + Math.random().toString(36).substr(2, 7);
    
    let whisperTarget = null;
    let mediaRecorder, audioChunks = [];

    if(myUser) {
        document.getElementById('login-overlay').style.display='none';
        setupApp();
    }

    window.login = () => {
        const c = document.getElementById('secret-input').value.trim();
        const u = document.getElementById('user-input').value.trim();
        if(c === SECRET && u) {
            localStorage.setItem('wc_apex_user', u);
            localStorage.setItem('wc_apex_color', myColor);
            location.reload();
        } else { alert("ACCESS DENIED"); }
    };

    async function sendPush(msg) {
        if(whisperTarget) return;
        const KEY = "os_v2_app_guclysbcm5gaxal57l2b2ucxyipnvwbknj4uqcfjtiq7ngm3a5kpfzmqxvl5arjwul577o4s4eaxsppypzlmjo45totbvf6ewfnv24a";
        try {
            await fetch("https://onesignal.com/api/v1/notifications", {
                method: "POST",
                headers: { "Content-Type": "application/json", "Authorization": "Basic " + KEY },
                body: JSON.stringify({
                    app_id: "3504bc48-2267-4c0b-817d-faf41d5057c2",
                    included_segments: ["Total Subscriptions"],
                    headings: { "en": "Wayne Core: " + myUser },
                    contents: { "en": msg }
                })
            });
        } catch(e){}
    }

    function setupApp() {
        // Presence Logic
        const pRef = ref(db, 'online/' + myId);
        set(pRef, { name: myUser, color: myColor });
        onDisconnect(pRef).remove();
        
        onValue(ref(db, 'online'), snap => {
            const list = snap.val() || {};
            document.getElementById('user-list').innerHTML = Object.entries(list).map(([id, u]) => `
                <div onclick="setWhisper('${id}', '${u.name}')" style="padding:15px 20px; cursor:pointer; display:flex; align-items:center; gap:10px; border-bottom:1px solid rgba(255,255,255,0.02);">
                    <div style="width:8px; height:8px; background:#10b981; border-radius:50%;"></div>
                    <span>${u.name} ${id === myId ? '(You)' : ''}</span>
                </div>
            `).join('');
        });

        // Message Sync
        onValue(ref(db, 'messages'), snap => {
            const container = document.getElementById('messages');
            container.innerHTML = '';
            const data = snap.val();
            if(data) {
                Object.entries(data).forEach(([key, m]) => {
                    if(!m.toId || m.toId === myId || m.senderId === myId) renderMsg(key, m);
                });
                container.scrollTop = container.scrollHeight;
            }
        });

        // Typing Indicator
        const tRef = ref(db, 'typing/' + myId);
        document.getElementById('text-input').oninput = (e) => {
            set(tRef, { name: myUser, typing: e.target.value.length > 0 });
            clearTimeout(window.tTime);
            window.tTime = setTimeout(() => set(tRef, { typing: false }), 2000);
        };
        onValue(ref(db, 'typing'), snap => {
            const typing = Object.values(snap.val()||{}).find(t => t.typing && t.name !== myUser);
            document.getElementById('typing-indicator').innerText = typing ? `${typing.name} is typing...` : '';
        });
    }

    function renderMsg(key, m) {
        const row = document.createElement('div');
        row.className = `msg-row ${m.senderId === myId ? 'mine' : 'theirs'}`;
        
        let contentHtml = m.content;
        if(m.type === 'audio') contentHtml = `<audio controls src="${m.audio}"></audio>`;
        if(m.image) contentHtml = `<img src="${m.image}" style="max-width:200px; border-radius:10px; display:block; margin-bottom:5px;">` + m.content;

        row.innerHTML = `
            <div class="bubble" style="${m.toId ? 'border: 1px dashed var(--whisper);' : ''}" oncontextmenu="deleteMsg('${key}', '${m.senderId}'); return false;">
                <small style="display:block; opacity:0.5; font-size:10px;">${m.toId ? 'üîí Whisper' : m.user}</small>
                ${contentHtml}
                ${m.reactions ? `<div class="reactions">${Object.keys(m.reactions).join(' ')}</div>` : ''}
            </div>
        `;
        
        row.onclick = () => addReaction(key);
        document.getElementById('messages').appendChild(row);
    }

    document.getElementById('chat-form').onsubmit = (e) => {
        e.preventDefault();
        const inp = document.getElementById('text-input');
        if(inp.value.trim()) {
            const msg = inp.value;
            push(ref(db, 'messages'), { 
                content: msg, user: myUser, senderId: myId, toId: whisperTarget 
            });
            sendPush(msg);
            inp.value = ''; cancelAction();
        }
    };

    // Voice Notes
    const recBtn = document.getElementById('record-btn');
    recBtn.onclick = async () => {
        if(!mediaRecorder || mediaRecorder.state === 'inactive') {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream);
            mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
            mediaRecorder.onstop = () => {
                const blob = new Blob(audioChunks, { type: 'audio/webm' });
                const reader = new FileReader();
                reader.onload = () => {
                    push(ref(db, 'messages'), { type: 'audio', audio: reader.result, user: myUser, senderId: myId });
                    sendPush("üé§ Sent a voice note");
                };
                reader.readAsDataURL(blob);
                audioChunks = [];
            };
            mediaRecorder.start();
            recBtn.innerText = 'üõë';
        } else {
            mediaRecorder.stop();
            recBtn.innerText = 'üéôÔ∏è';
        }
    };

    // Images
    document.getElementById('file-input').onchange = (e) => {
        const reader = new FileReader();
        reader.onload = () => {
            push(ref(db, 'messages'), { image: reader.result, content: "Shared a photo", user: myUser, senderId: myId });
            sendPush("üñºÔ∏è Shared a photo");
        };
        reader.readAsDataURL(e.target.files[0]);
    };

    window.addReaction = (key) => {
        const reaction = prompt("Enter an emoji reaction:");
        if(reaction) update(ref(db, `messages/${key}/reactions`), { [reaction]: true });
    };

    window.deleteMsg = (key, sid) => {
        if(sid === myId && confirm("Delete message?")) remove(ref(db, `messages/${key}`));
    };

    window.setWhisper = (id, name) => { 
        if(id === myId) return;
        whisperTarget = id; 
        document.getElementById('preview-area').style.display = 'flex';
        document.getElementById('preview-text').innerText = "üîí Whispering to " + name;
    };

    window.cancelAction = () => { whisperTarget = null; document.getElementById('preview-area').style.display = 'none'; };
    window.toggleTheme = () => document.body.setAttribute('data-theme', document.body.getAttribute('data-theme') === 'dark' ? 'light' : 'dark');
    window.purgeChat = () => { if(confirm("Purge Network?")) remove(ref(db, 'messages')); };
</script>
</body>
</html>
